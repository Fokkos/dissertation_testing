{% extends 'base.html' %}

{% block head %}
    <title>Flask demo</title>
{% endblock %}

{% block body %}



{% if error %}
  <p class=error><strong>Error:</strong> {{ error }}
{% endif %}

<!-- row 2: candidate & voter management-->
<!-- variable settings -->
<div>
  <div class="w-full h-1/3 flex border">
    <!-- VIEW candidates -->
    {% with type = 'candidate', dataset = data.candidates %}
      {% include 'partials/view_data.html' %}
    {% endwith %}
    <!-- VIEW voters -->
    {% with type = 'voter', dataset = data.voters %}
      {% include 'partials/view_data.html' %}
    {% endwith %}
  </div>
  <div id='election-settings' class='flex justify-center'>
    <div>
      <div class='font-bold text-2xl text-center'>
        <h1>Election Settings</h1>
      </div>
      <p class="text-center" id='showElectionSettings'>Getting settings...</p>
    </div>
  </div>
    
  <div class='flex justify-center py-2'>
    <button 
        id="findWinnerButton" 
        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline"
        onclick="findWinner()">
        Find winner(s)
    </button>
  </div>
</div>

  <!-- Winner Dialog -->
  <div id="winnerModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
    <div id='winnerModalOverlay' class="bg-gray-500 bg-opacity-50 fixed inset-0 transition-opacity"></div> <!-- Background overlay -->
    <div class="bg-white rounded-lg border-2 px-8 py-4 max-w-m relative"> <!-- Relative positioning for overlay -->
      <div class='text-3xl flex justify-center'>
        <h2 id='winnerDivTitleText'><strong>Winner:</strong></h2>
      </div>
      <div class='winnersDiv'></div>
      <div class='flex justify-center'>
        <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 mt-2 rounded focus:outline-none focus:shadow-outline" onclick="closeModal('winnerModal')">Close</button>
      </div>
      
    </div>
  </div>

<script>
  // on load, show the election settings
  function setElectionSettingsText() {
    electionText = 
      "Candidates: {{ data.candidates | length }} <br>" +
      "Voters: {{ data.voters | length }} <br>" +
      "Distance Measure: {{ data.distance_measure }} <br>" +
      "Election Type: {{ data.election_type }} <br>" +
      "Voting Style: {{ data.voting_style }} <br>";
  
    {% if data.election_type == 'multi-winner' %}
      electionText += "K-Value: {{ data.k }} <br>";
    {% elif data.election_type == 'participatory-budget' %}
      electionText += "Budget: {{ data.budget }} <br>";
    {% endif %}

    return electionText;
  }
  
  window.onload = function() {
    document.getElementById('showElectionSettings').innerHTML = setElectionSettingsText();
  }

  function checkResultsValidation() {
    if ({{ data.voters | length }} < 1 || {{ data.candidates | length }} < 2) {
      alert('Need at least 1 voter and 2 candidates to calculate results');
      return false;
    }
    return true;
  }

  function findWinner() {
    if (checkResultsValidation()) {
      
      // clear the winnersDiv
      document.querySelector('.winnersDiv').innerHTML = '';

      // get the Winner of the election
      getWinner()

      // open the modal
      openModal('winnerModal');

      // confetti
      confetti({
        particleCount: 500,
        spread: 100
      });
    }
  }

  function getWinner() {
    const url = "{{ url_for('getWinner') }}"
    fetch(url)
    .then(response => response.json())  
    .then(json => {
      if (json['election_type'] == 'single-winner') {
        document.getElementById('winnerDivTitleText').innerText = 'Winner:';
        createIndividualText(0, json['winner'], json['voting_style'], json['election_type']);
      } else {
        document.getElementById('winnerDivTitleText').innerText = 'Winners:';
        for (winner in json['winner'].slice(0, 10)) {
          createIndividualText(winner, json['winner'][winner], json['voting_style'], json['election_type']);
        }
        if (json['election_type'] == 'participatory-budget') {
          if (!json['winners']) { // if no winner are found (only vote is above budget)
            let winnerDiv = document.createElement('div');
            winnerDiv.className = 'flex justify-center pt-3 px-10 text-3xl font-bold';
            let winnerText = document.createTextNode('No winners found');
            winnerDiv.appendChild(winnerText);
            document.querySelector('.winnersDiv').appendChild(winnerDiv);

            let infoDiv = document.createElement('div');
            infoDiv.className = 'flex justify-center pt-3 px-10 text-xl font-bold';
            let infoText = document.createTextNode('All votes made were above the allocated budget.');
            infoDiv.appendChild(infoText);
            document.querySelector('.winnersDiv').appendChild(infoDiv);
            
          } else {
            console.log(json['remaining_budget']);
            let winnerDiv = document.createElement('div');
            winnerDiv.className = 'flex justify-center pt-3 px-10 text-sm font-bold';
            let winnerText = document.createTextNode('Remaining Budget: ' + json['remaining_budget']);
            winnerDiv.appendChild(winnerText);
            document.querySelector('.winnersDiv').appendChild(winnerDiv);

            if (json['winner'].length > 10) {
              let winnerDiv = document.createElement('div');
              winnerDiv.className = 'flex justify-center pt-3 px-10 text-sm font-bold';
              let winnerLink = document.createElement('a');
              winnerLink.href = "/winners";
              winnerLink.innerText = 'Too many winners to display, click here to see all winners.';
              winnerDiv.appendChild(winnerLink);
              document.querySelector('.winnersDiv').appendChild(winnerDiv);
            }
          }
        }
      }
    })
  }

  function getTextSize(position){
    if (position == 0){
      return ['text-3xl'];
    } else if (position == 1){
      return ['text-2xl'];
    } else if (position == 2){
      return ['text-xl'];
    } else {
      return ['text-lg'];
    }
  }

  function getScoreType(voting_style) {
    if (voting_style == 'average-voter') {
      return 'Distance: ';
    }
    if (voting_style == 'ranked-choice') {
      return 'Borda Score: ';
    }
    if (voting_style == 'plurality') {
      return 'Votes: ';
    }
  }

  function createIndividualText(position, winner, voting_style, election_type) {
    const winnerDiv = document.createElement('div');
    //give winnerDiv a class
    winnerDiv.className = 'flex justify-center py-0 px-10 font-bold';
    // get the text size of the current position and add it to the winnerDiv
    // spread operator to add multiple classes (...list)
    winnerDiv.classList.add(...getTextSize(position));
    //create a text node with the winner name
    const winnerText = document.createTextNode('#' + (parseInt(position)+1) + ': ' + winner[0]);
    //append the text node to the winnerDiv
    winnerDiv.appendChild(winnerText);
    //append the winnerDiv to the winnersDiv
    document.querySelector('.winnersDiv').appendChild(winnerDiv);

    scoreDiv = document.createElement('div');
    scoreDiv.className = 'flex justify-center py-0 px-10 text-sm';
    let scoreText = (getScoreType(voting_style) + Math.round(parseFloat(winner[1]) * 100) / 100);
    if (election_type == 'participatory-budget') {
      scoreText += (",   Cost: " + winner[2]);
    }
    scoreText = document.createTextNode(scoreText);
    scoreDiv.appendChild(scoreText);
    document.querySelector('.winnersDiv').appendChild(scoreDiv);
  }
</script>

{% endblock %}